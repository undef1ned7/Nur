// src/components/Clients/Clients.jsx
import React, { useEffect, useMemo, useState } from "react";
import "./client.scss";
import api from "../../../../api";
import {
  getAll,
  createClient,
  updateClient,
  removeClient,
} from "./clientStore";

const fmtMoney = (v) => (Number(v) || 0).toLocaleString() + " —Å";

export default function ConsultingClients() {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [q, setQ] = useState("");

  const [isFormOpen, setIsFormOpen] = useState(false);
  const [editId, setEditId] = useState(null);

  const [confirmId, setConfirmId] = useState(null);
  const [deletingId, setDeletingId] = useState(null);

  const load = async () => {
    try {
      setLoading(true);
      setErr("");
      const list = await getAll();
      setRows(
        list
          .slice()
          .sort(
            (a, b) =>
              new Date(b.updated_at || b.created_at || 0) -
              new Date(a.updated_at || a.created_at || 0)
          )
      );
    } catch (e) {
      console.error(e);
      setErr("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ).");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    load();
  }, []);

  const filtered = useMemo(() => {
    const t = q.trim().toLowerCase();
    let base = rows.slice();
    if (t) {
      base = base.filter((r) =>
        [r.full_name, r.phone, r.seller, r.service]
          .filter(Boolean)
          .some((v) => String(v).toLowerCase().includes(t))
      );
    }
    return base.sort(
      (a, b) =>
        new Date(b.updated_at || b.created_at || 0) -
        new Date(a.updated_at || a.created_at || 0)
    );
  }, [rows, q]);

  const onCreate = () => {
    setEditId(null);
    setIsFormOpen(true);
  };
  const onEdit = (id) => {
    setEditId(id);
    setIsFormOpen(true);
  };

  const askDelete = (id) => setConfirmId(String(id));
  const cancelDelete = () => setConfirmId(null);
  const doDelete = async (id) => {
    const idStr = String(id);
    setDeletingId(idStr);
    try {
      await removeClient(id);
      setRows((prev) => prev.filter((c) => String(c.id) !== idStr));
    } catch (e) {
      console.error(e);
      setErr("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–æ).");
    } finally {
      setDeletingId(null);
      setConfirmId(null);
    }
  };

  return (
    <section className="clients">
      <header className="clients__header">
        <div>
          <h2 className="clients__title">–ö–ª–∏–µ–Ω—Ç—ã</h2>
          <p className="clients__subtitle">–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (–±–µ–∑ –±—ç–∫–∞)</p>
        </div>

        <div className="clients__actions">
          <div className="clients__search">
            <span className="clients__searchIcon" aria-hidden>
              üîé
            </span>
            <input
              className="clients__searchInput"
              placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, –ø—Ä–æ–¥–∞–≤—Ü—É, —É—Å–ª—É–≥–µ‚Ä¶"
              value={q}
              onChange={(e) => setQ(e.target.value)}
              aria-label="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤"
            />
          </div>

          <button
            className="clients__btn clients__btn--primary"
            onClick={onCreate}
          >
            + –ö–ª–∏–µ–Ω—Ç
          </button>
        </div>
      </header>

      {err && <div className="clients__error">{err}</div>}

      <div className="clients__tableWrap">
        <table className="clients__table">
          <thead>
            <tr>
              <th>–ò–º—è</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th>–î–∞—Ç–∞</th>
              <th>–ü—Ä–æ–¥–∞–≤–µ—Ü</th>
              <th>–£—Å–ª—É–≥–∞</th>
              <th>–¶–µ–Ω–∞</th>
              <th aria-label="–î–µ–π—Å—Ç–≤–∏—è" />
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td className="clients__empty" colSpan={7}>
                  –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
                </td>
              </tr>
            ) : filtered.length ? (
              filtered.map((c) => {
                const isConfirm = String(c.id) === String(confirmId);
                const isDeleting = String(c.id) === String(deletingId);
                return (
                  <tr key={c.id}>
                    <td className="clients__ellipsis" title={c.full_name}>
                      {c.full_name || "‚Äî"}
                    </td>
                    <td>{c.phone || "‚Äî"}</td>
                    <td>{c.date || "‚Äî"}</td>
                    <td className="clients__ellipsis" title={c.seller}>
                      {c.seller || "‚Äî"}
                    </td>
                    <td className="clients__ellipsis" title={c.service}>
                      {c.service || "‚Äî"}
                    </td>
                    <td>{fmtMoney(c.price)}</td>
                    <td className="clients__rowActions">
                      {isConfirm ? (
                        <>
                          <span
                            className="clients__muted"
                            style={{ marginRight: 8 }}
                          >
                            –£–¥–∞–ª–∏—Ç—å?
                          </span>
                          <button
                            className="clients__btn"
                            onClick={() => doDelete(c.id)}
                            disabled={isDeleting}
                          >
                            –î–∞
                          </button>
                          <button
                            className="clients__btn clients__btn--secondary"
                            onClick={cancelDelete}
                            disabled={isDeleting}
                          >
                            –ù–µ—Ç
                          </button>
                        </>
                      ) : (
                        <>
                          <button
                            className="clients__btn"
                            onClick={() => onEdit(c.id)}
                          >
                            –ò–∑–º.
                          </button>
                          <button
                            className="clients__btn clients__btn--secondary"
                            onClick={() => askDelete(c.id)}
                          >
                            –£–¥–∞–ª–∏—Ç—å
                          </button>
                        </>
                      )}
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr>
                <td className="clients__empty" colSpan={7}>
                  –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {isFormOpen && (
        <ClientForm
          id={editId}
          onClose={() => setIsFormOpen(false)}
          afterSave={load}
          rows={rows}
        />
      )}
    </section>
  );
}

/* ===== —Ñ–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ =====
 * –°–æ–∑–¥–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ò–º—è –∏ –¢–µ–ª–µ—Ñ–æ–Ω
 * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π
 */
const ClientForm = ({ id, onClose, afterSave, rows }) => {
  const editing = !!id;
  const current = editing
    ? rows.find((c) => String(c.id) === String(id))
    : null;

  // –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è (–≤—Å–µ–≥–¥–∞)
  const [full_name, setFullName] = useState(current?.full_name || "");
  const [phone, setPhone] = useState(current?.phone || "");

  // —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
  const [date, setDate] = useState(current?.date || "");
  const [seller, setSeller] = useState(current?.seller || "");
  const [service, setService] = useState(current?.service || "");
  const [price, setPrice] = useState(
    current?.price != null ? String(current.price) : ""
  );

  const [err, setErr] = useState("");
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    const onKey = (e) => e.key === "Escape" && onClose();
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [onClose]);

  const submit = async (e) => {
    e.preventDefault();
    setErr("");

    const name = full_name.trim();
    if (!name) return setErr("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞.");
    if (name.length < 2 || name.length > 120)
      return setErr("–ò–º—è: 2‚Äì120 —Å–∏–º–≤–æ–ª–æ–≤.");

    const dtoCreate = {
      full_name: name,
      phone: (phone || "").trim(),
      // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è
    };

    const dtoEdit = {
      full_name: name,
      phone: (phone || "").trim(),
      date: (date || "").trim(),
      seller: (seller || "").trim(),
      service: (service || "").trim(),
      price: price === "" ? 0 : Number(String(price).replace(",", ".")) || 0,
    };

    setSaving(true);
    try {
      if (editing) {
        await updateClient(current.id, dtoEdit);
      } else {
        await createClient(dtoCreate);
      }
      await afterSave?.();
      onClose();
    } catch (e2) {
      console.error(e2);
      setErr("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–æ).");
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="clients__modalOverlay" onClick={onClose}>
      <div
        className="clients__modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="clients-form-title"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="clients__modalHeader">
          <div id="clients-form-title" className="clients__modalTitle">
            {editing ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞" : "–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç"}
          </div>
          <button
            className="clients__iconBtn"
            onClick={onClose}
            aria-label="–ó–∞–∫—Ä—ã—Ç—å"
          >
            √ó
          </button>
        </div>

        {!!err && (
          <div className="clients__error" style={{ marginTop: 8 }}>
            {err}
          </div>
        )}

        <form className="clients__form" onSubmit={submit}>
          <div className="clients__formGrid">
            {/* –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–µ –ø–æ–ª—è */}
            <div className="clients__field">
              <label className="clients__label">–ò–º—è *</label>
              <input
                className="clients__input"
                value={full_name}
                onChange={(e) => setFullName(e.target.value)}
                required
                autoFocus
              />
            </div>

            <div className="clients__field">
              <label className="clients__label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
              <input
                className="clients__input"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
                placeholder="+996700000000"
              />
            </div>

            {/* —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ */}
            {editing && (
              <>
                <div className="clients__field">
                  <label className="clients__label">–î–∞—Ç–∞</label>
                  <input
                    type="date"
                    className="clients__input"
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                  />
                </div>

                <div className="clients__field">
                  <label className="clients__label">–ü—Ä–æ–¥–∞–≤–µ—Ü</label>
                  <input
                    className="clients__input"
                    value={seller}
                    onChange={(e) => setSeller(e.target.value)}
                    placeholder="–§–ò–û –ø—Ä–æ–¥–∞–≤—Ü–∞"
                  />
                </div>

                <div className="clients__field">
                  <label className="clients__label">–£—Å–ª—É–≥–∞</label>
                  <input
                    className="clients__input"
                    value={service}
                    onChange={(e) => setService(e.target.value)}
                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"
                  />
                </div>

                <div className="clients__field">
                  <label className="clients__label">–¶–µ–Ω–∞, —Å</label>
                  <input
                    className="clients__input"
                    type="number"
                    min="0"
                    step="0.01"
                    value={price}
                    onChange={(e) => setPrice(e.target.value)}
                    placeholder="0"
                  />
                </div>
              </>
            )}
          </div>

          <div className="clients__formActions">
            <button
              type="button"
              className="clients__btn"
              onClick={onClose}
              disabled={saving}
            >
              –û—Ç–º–µ–Ω–∞
            </button>
            <button
              type="submit"
              className="clients__btn clients__btn--primary"
              disabled={saving}
            >
              {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶" : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};
