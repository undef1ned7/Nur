# Настройки принтера кассы (Кафе) — API для бэкенда

Этот документ описывает, как бэкенд должен **сохранять** и затем **возвращать** настройки принтера кассы (чековый принтер) для сектора **Кафе**.

Источник контракта на фронте: `src/Components/pages/Info/Settings/CafeReceiptPrinterSettings.jsx`.

---

## Что сохраняем

Фронт сохраняет два значения:

- **`printer`**: строка-привязка принтера (binding)
- **`bridge_url`**: URL локального printer-bridge (нужен для Wi‑Fi печати; для USB может быть пустым)

Фронт отправляет их на бэкенд запросом:

- **`PATCH /cafe/receipt-printer/`**
- JSON тело: `{ "printer": "<binding>", "bridge_url": "<url>" }`

---

## Формат поля `printer` (binding)

Поле `printer` — это строка, которую фронт формирует и хранит как есть (в `localStorage` ключ `cafe_receipt_printer`).

Поддерживаемые форматы:

### 1) Wi‑Fi (RAW TCP печать через bridge)

- `ip/<ipv4>` — порт по умолчанию **9100**
- `ip/<ipv4>:<port>`

Примеры:

- `ip/192.168.1.200`
- `ip/192.168.1.200:9100`

Валидация:

- IPv4
- порт 1..65535 (если не задан — считать 9100)

### 2) USB (WebUSB)

- `usb/<usbKey>`

Где `usbKey` обычно вида:

- `<vidHex>:<pidHex>:<serial>`

Примеры:

- `usb/1fc9:2016:noserial`
- `usb/04b8:0e15:ABCD1234`

Примечания:

- `serial` может быть строкой `noserial`.
- Даже если бэкенд хранит USB-привязку, **само WebUSB-разрешение** — это разрешение браузера на конкретном ПК, поэтому на другом ПК может потребоваться повторный выбор устройства.

---

## API

### 1) Получить настройки принтера кассы

**Метод:** `GET`  
**URL:** `/cafe/receipt-printer/`

**Успех (рекомендуемо):** `200 OK`

```json
{
  "printer": "ip/192.168.1.200:9100",
  "bridge_url": "http://127.0.0.1:5179/print",
  "updated_at": "2026-02-12T10:30:00Z"
}
```

Если настройки ещё не сохранены, рекомендуемый ответ (чтобы фронту не ловить 404):

```json
{
  "printer": "",
  "bridge_url": "",
  "updated_at": null
}
```

### 2) Сохранить/обновить настройки (upsert)

**Метод:** `PATCH`  
**URL:** `/cafe/receipt-printer/`  
**Content-Type:** `application/json`

**Тело:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `printer` | string | да | Binding принтера (`ip/...` или `usb/...`) |
| `bridge_url` | string | нет | URL printer-bridge, можно пустую строку |

**Пример:**

```json
{
  "printer": "usb/1fc9:2016:noserial",
  "bridge_url": "http://127.0.0.1:5179/print"
}
```

**Ответ:** `200 OK` (вернуть сохранённое)

```json
{
  "printer": "usb/1fc9:2016:noserial",
  "bridge_url": "http://127.0.0.1:5179/print",
  "updated_at": "2026-02-12T10:31:12Z"
}
```

---

## Ошибки и коды ответов

- `400 Bad Request`
  - некорректный `printer` (не `ip/...` и не `usb/...`, или IP/порт невалидны)
  - некорректный `bridge_url` (если вы валидируете URL)
- `401 Unauthorized` — не авторизован
- `403 Forbidden` — нет доступа к компании/точке
- `500` — прочее

Формат ошибки на ваше усмотрение, но удобно возвращать:

```json
{ "ok": false, "error": "Человекочитаемая причина" }
```

---

## Хранение (scope): на компанию или на кассу

В текущем фронте нет передачи `pos_id/cashbox_id`, поэтому минимальный вариант:

- хранить настройки **на компанию** (1 запись на компанию)

Если в будущем нужно хранить на конкретную кассу/терминал:

- добавить идентификатор рабочего места (например `pos_id`)
- расширить контракт:
  - `GET /cafe/receipt-printer/?pos_id=...`
  - `PATCH /cafe/receipt-printer/?pos_id=...`

---

## Безопасность и практические нюансы

- Endpoint должен быть закрыт авторизацией.
- Для Wi‑Fi печати нужен доступ к `ip:port` принтера:
  - если ваш бэкенд крутится на VPS (в интернете), он обычно **не видит** `192.168.x.x`.
  - поэтому Wi‑Fi печать обычно делается через локальный **printer-bridge** в сети кафе.
- `bridge_url` в этом экране — это URL локального bridge, который запускается командой `npm run printer-bridge` на ПК в сети.

