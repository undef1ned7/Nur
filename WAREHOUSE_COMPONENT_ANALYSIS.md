# Анализ компонента Warehouse.jsx

## Обзор

Компонент `Warehouse.jsx` представляет собой полнофункциональный интерфейс управления складом товаров с поддержкой поиска, фильтрации, пагинации, массовых операций и переключения режимов отображения.

---

## Архитектура и технологии

### Используемые технологии
- **React** (функциональные компоненты с хуками)
- **Redux Toolkit** (управление состоянием)
- **React Router** (навигация и URL параметры)
- **Lucide React** (иконки)
- **SCSS** (стилизация)

### Структура зависимостей
```javascript
// Redux
- useDispatch, useSelector
- fetchProductsAsync, fetchBrandsAsync, fetchCategoriesAsync
- bulkDeleteProductsAsync

// React Router
- useNavigate, useSearchParams

// Локальные компоненты
- FilterModal (модальное окно фильтров)
- AlertModal (модальное окно подтверждения)
```

---

## Функциональность

### 1. Управление состоянием

#### Локальное состояние
```javascript
- searchTerm: строка поиска (ввод пользователя)
- debouncedSearchTerm: отложенный поиск (300ms)
- showFilterModal: видимость модального окна фильтров
- filters: объект с активными фильтрами
- selectedRows: Set выбранных товаров (для массовых операций)
- currentPage: текущая страница пагинации
- bulkDeleting: флаг процесса массового удаления
- showDeleteConfirmModal: видимость модального окна подтверждения
- viewMode: режим отображения ("table" | "cards")
```

#### Redux состояние
```javascript
- products: список товаров (из useProducts())
- loading: состояние загрузки
- count: общее количество товаров
- next/previous: ссылки на следующую/предыдущую страницы
- brands: список брендов
- categories: список категорий
```

### 2. Поиск и фильтрация

#### Поиск
- **Debounce**: 300ms задержка для оптимизации запросов
- **Параметр API**: `search` (поиск по названию и штрих-коду)
- **Автоматический сброс страницы**: при изменении поиска возврат на страницу 1

```javascript
// Debounce реализация
useEffect(() => {
  if (debounceTimerRef.current) {
    clearTimeout(debounceTimerRef.current);
  }
  debounceTimerRef.current = setTimeout(() => {
    setDebouncedSearchTerm(searchTerm);
  }, 300);
  return () => {
    if (debounceTimerRef.current) {
      clearTimeout(debounceTimerRef.current);
    }
  };
}, [searchTerm]);
```

#### Фильтры
Поддерживаемые фильтры (через FilterModal):
- **Тип товара**: product, service, bundle
- **Пресеты**: товары со скидкой, истекающий срок годности, и т.д.
- **Категория**: выбор из списка категорий
- **Бренд**: выбор из списка брендов
- **Цена**: фильтр по цене (базовая, закупки, себестоимость, скидка)
- **Срок годности**: фильтр по сроку годности
- **Продаваемость**: фильтр по продажам за период

### 3. Пагинация

#### Параметры
- **Размер страницы**: 100 товаров (константа `PAGE_SIZE`)
- **URL синхронизация**: номер страницы сохраняется в URL параметрах
- **Расчет страниц**: `Math.ceil(count / PAGE_SIZE)`

#### Навигация
```javascript
const handlePageChange = (newPage) => {
  if (newPage < 1 || (totalPages && newPage > totalPages)) return;
  setSelectedRows(new Set()); // Сброс выбора при смене страницы
  setCurrentPage(newPage);
};
```

### 4. Режимы отображения

#### Таблица (table)
- Полная информация о товарах
- Колонки: чекбокс, №, название (с изображением), код, артикул, единица измерения, цена, скидка, остатки
- Минимальная ширина: 1100px
- Клик по строке: переход на страницу деталей товара

#### Карточки (cards)
- Адаптивная сетка: 1 колонка (мобильные), 2 (планшеты), 3 (десктоп)
- Компактное отображение ключевой информации
- Изображение товара, название, код, артикул, единица измерения
- Цена, скидка, остатки в отдельных блоках

#### Сохранение режима
```javascript
const STORAGE_KEY = "warehouse_view_mode";
// Сохранение в localStorage
localStorage.setItem(STORAGE_KEY, viewMode);
// Автоматический выбор на основе размера экрана
const isSmall = window.matchMedia("(max-width: 1199px)").matches;
return isSmall ? "cards" : "table";
```

### 5. Массовые операции

#### Выбор товаров
- **Одиночный выбор**: клик по чекбоксу
- **Выбор всех**: чекбокс в заголовке таблицы/панели карточек
- **Сброс выбора**: при смене страницы или через кнопку "Сбросить"

#### Массовое удаление
```javascript
// API запрос
DELETE /main/products/bulk-delete/
// Тело запроса
{
  ids: ["uuid1", "uuid2", ...],
  soft: true,        // Мягкое удаление
  require_all: false // Не требовать наличие всех товаров
}
```

**Процесс:**
1. Выбор товаров через чекбоксы
2. Нажатие "Удалить выбранные"
3. Подтверждение в модальном окне
4. Отправка запроса на сервер
5. Обновление списка товаров после успешного удаления

### 6. Навигация

#### Переход на детали товара
```javascript
const handleProductClick = (product) => {
  navigate(`/crm/sklad/${product.id}`);
};
```

#### Создание нового товара
```javascript
onClick={() => navigate("/crm/sklad/add-product")}
```

---

## API взаимодействие

### Получение списка товаров

**Эндпоинт**: `GET /main/products/list/`

**Параметры запроса:**
```javascript
{
  page: 1,                    // Номер страницы
  search: "поисковый запрос",  // Поиск по названию/штрих-коду
  brand: "brand-uuid",         // Фильтр по бренду
  category: "category-uuid",   // Фильтр по категории
  kind: "product,service",      // Тип товара (через запятую)
  // ... другие фильтры из FilterModal
}
```

**Структура ответа:**
```javascript
{
  count: 1250,           // Общее количество
  next: "url",           // Следующая страница (или null)
  previous: "url",       // Предыдущая страница (или null)
  results: [
    {
      id: "uuid",
      name: "Название",
      code: "CODE123",
      article: "ART123",
      barcode: "1234567890123",
      price: "150.00",
      discount_percent: "10.00",
      quantity: 25,
      unit: "шт",
      kind: "product",
      images: [...],
      brand: {...},
      category: {...}
    }
  ]
}
```

### Массовое удаление

**Эндпоинт**: `DELETE /main/products/bulk-delete/`

**Тело запроса:**
```javascript
{
  ids: ["uuid1", "uuid2"],
  soft: true,
  require_all: false
}
```

### Получение справочников

**Бренды**: `GET /main/brands/`
**Категории**: `GET /main/categories/`

---

## Оптимизации и лучшие практики

### 1. Debounce для поиска
- Снижает количество запросов к API
- Улучшает производительность
- Улучшает UX (меньше миганий интерфейса)

### 2. Мемоизация вычислений
```javascript
const getRowNumber = (index) => {
  const effectivePageSize = PAGE_SIZE || products.length || 1;
  return (currentPage - 1) * effectivePageSize + index + 1;
};
```

### 3. Условный рендеринг
- Загрузка: показывается индикатор
- Пустой результат: показывается сообщение
- Данные: отображается таблица/карточки

### 4. Обработка изображений
```javascript
const getPrimaryImage = (product) => {
  if (!product?.images || !Array.isArray(product.images)) return null;
  const primaryImage = product.images.find((img) => img.is_primary);
  return primaryImage || product.images[0] || null;
};
```

**Fallback**: если изображение не загружается, показывается placeholder

### 5. Форматирование данных
```javascript
// Цена: всегда 2 знака после запятой
const formatPrice = (price) => parseFloat(price || 0).toFixed(2);

// Остатки: форматирование с пробелами (1 000)
const formatStock = (stock) => {
  if (stock === null || stock === undefined) return "—";
  return stock.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
};
```

---

## Потенциальные улучшения

### 1. Обработка ошибок
**Текущее состояние:**
```javascript
catch (e) {
  alert("Не удалось удалить товары: " + (e.message || e));
}
```

**Рекомендация:**
- Использовать централизованную систему уведомлений
- Показывать детальные сообщения об ошибках
- Логировать ошибки для отладки

### 2. Оптимистичные обновления
- Обновлять UI до получения ответа от сервера
- Откатывать изменения при ошибке

### 3. Виртуализация списка
- Для больших списков товаров использовать виртуализацию
- Улучшит производительность при отображении 100+ товаров

### 4. Кэширование
- Кэшировать справочники (бренды, категории)
- Использовать React Query или SWR для кэширования данных

### 5. Accessibility
- Добавить ARIA-атрибуты
- Улучшить навигацию с клавиатуры
- Добавить подсказки для скринридеров

### 6. Тестирование
- Unit-тесты для утилит (formatPrice, formatStock)
- Integration-тесты для основных сценариев
- E2E-тесты для критических путей

---

## Структура компонента

```
Warehouse
├── Header
│   ├── Заголовок и описание
│   └── Кнопка "Создать товар"
├── Search and Filters
│   ├── Поле поиска
│   ├── Информация о количестве
│   └── Переключатель вида + кнопка фильтров
├── Bulk Actions Bar (условно)
│   ├── Информация о выбранных товарах
│   └── Кнопки действий
├── Products Display
│   ├── Table View (условно)
│   │   └── Таблица с товарами
│   └── Cards View (условно)
│       └── Сетка карточек
├── Pagination (условно)
│   └── Навигация по страницам
├── FilterModal (условно)
│   └── Модальное окно фильтров
└── AlertModal (условно)
    └── Модальное окно подтверждения
```

---

## Зависимости компонента

### Внешние зависимости
- `FilterModal` - компонент фильтров
- `AlertModal` - компонент подтверждения
- Redux actions и selectors
- React Router hooks

### Внутренние зависимости
- `placeholder.png` - изображение-заглушка
- `Warehouse.scss` - стили компонента

---

## Ключевые функции

### 1. handleProductClick
Переход на страницу деталей товара

### 2. handleRowSelect
Выбор/снятие выбора товара

### 3. handleSelectAll
Выбор всех товаров на текущей странице

### 4. handleBulkDelete
Инициация массового удаления

### 5. confirmBulkDelete
Подтверждение и выполнение массового удаления

### 6. handleApplyFilters
Применение фильтров из модального окна

### 7. handleResetFilters
Сброс всех фильтров

### 8. handlePageChange
Навигация по страницам

### 9. formatPrice
Форматирование цены (2 знака после запятой)

### 10. formatStock
Форматирование остатков (с пробелами)

### 11. getPrimaryImage
Получение основного изображения товара

---

## Особенности реализации

### 1. Синхронизация URL и состояния
```javascript
// Сохранение страницы в URL
useEffect(() => {
  const params = new URLSearchParams();
  if (currentPage > 1) {
    params.set("page", currentPage.toString());
  }
  setSearchParams(params, { replace: true });
}, [currentPage]);

// Восстановление страницы из URL
const pageFromUrl = parseInt(searchParams.get("page") || "1", 10);
```

### 2. Управление выбором товаров
- Использование `Set` для эффективного хранения выбранных ID
- Автоматический сброс при смене страницы
- Визуальная индикация выбранных товаров

### 3. Адаптивность
- Автоматический выбор режима отображения на основе размера экрана
- Адаптивная сетка карточек (1/2/3 колонки)
- Минимальная ширина таблицы для корректного отображения

---

## Производительность

### Оптимизации
✅ Debounce для поиска (300ms)
✅ Условный рендеринг компонентов
✅ Мемоизация вычислений (getRowNumber)
✅ Ленивая загрузка изображений (onError fallback)

### Потенциальные узкие места
⚠️ Отсутствие виртуализации для больших списков
⚠️ Повторные запросы при изменении фильтров
⚠️ Отсутствие кэширования справочников

---

## Безопасность

### Текущие меры
- Проверка прав доступа на уровне API
- Валидация данных перед отправкой
- Обработка ошибок от сервера

### Рекомендации
- Добавить проверку прав доступа на клиенте
- Валидация данных перед массовым удалением
- Подтверждение критических операций

---

## Заключение

Компонент `Warehouse.jsx` представляет собой хорошо структурированный и функциональный интерфейс управления складом. Он включает:

✅ Полнофункциональный поиск и фильтрацию
✅ Два режима отображения (таблица/карточки)
✅ Массовые операции
✅ Пагинацию с синхронизацией URL
✅ Адаптивный дизайн
✅ Оптимизации производительности

**Общая оценка**: 8/10

**Основные области для улучшения:**
1. Обработка ошибок
2. Виртуализация для больших списков
3. Кэширование данных
4. Тестирование
5. Accessibility

